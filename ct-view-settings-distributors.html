<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../iron-form/iron-form.html">
<link rel="import" href="../ct-core-utils/ct-api-consumer-behaviour.html">
<link rel="import" href="../ct-delete-dialog/ct-delete-dialog.html">
<link rel="import" href="../ct-editable-switcher/ct-editable-switcher.html">

<!--
`ct-view-settings-distributors`
Element to add and view distributor settings

@demo demo/index.html
-->

<dom-module id="ct-view-settings-distributors">
  <template>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <style is="custom-styles">
      :host {
        display: block;
        --paper-input-container:{
          border-top: 1px solid #ccc;
          border-left: 1px solid #ccc;
          border-right: 1px solid #ccc;
          border-bottom: none;
          padding: 0 !important;
        };

        --paper-input-container-input: {
          text-overflow: ellipsis;
          width: calc(100% - 20px);
          margin-left: 10px;
        };

        --paper-input-container-label: {
          margin-left: 10px;
          width: calc(100% - 20px);
        };
      }

      .new-container .row {
        display: flex;
        align-items: center;
      }

      .margin-10v {
        margin: 10px 0;
      }

      paper-material {
        background: #fff;
        margin-bottom: 15px;
        padding: 10px;
      }


      paper-icon-button + paper-icon-button {
        margin-left: 15px;
      }  this.fire('deleteDistributor', e.detail.id);
      paper-input {
        text-overflow: ellipsis;
        width: calc(~100% - 10px);
      }


    </style>



    <paper-material>
      <div class="fluid-container new-container margin-10v">
        <form
                is="iron-form"
                class="row"
                id="form"
                disable-native-validation-ui
                method="POST"
                novalidate>

          <div class="col-sm-3">
            <paper-input
                    id="newDistName"
                    label="New Distributor Name"
                    type="text"
                    name="name"
                    required
                    error-message="Please provide a name for the new distributor"
                    type="text"></paper-input>
          </div>


          <div class="col-sm-3">
            <paper-input
                    id="newDistNumber"
                    label="New Distributor Number"
                    required
                    name="contactNumber"
                    error-message="Please provide a number for the new distributor"
                    type="text"></paper-input>
          </div>

          <div class="col-sm-3">
            <paper-input
                    id="newDistAddress"
                    label="New Distributor Address"
                    required
                    name="address"
                    error-message="Please provide an address for the new distributor"
                    type="text"></paper-input>
          </div>
          <div class="col-sm-3">
            <paper-button class="btn btn-primary btn-block" on-tap="_submitForm" raised>Add Distributor</paper-button>
          </div>
        </form>
      </div>
    </paper-material>

    <paper-material>

      <div class="fluid-container">

        <div class="row">
          <div class="col-xs-12">
            <div class="table-responsive">
              <table class="table table-striped table-bordered table-hover table-middle">
                <thead>
                <th>Distributor Name</th>
                <th>Contact Number</th>
                <th>Address</th>
                <th class="text-center">Actions</th>
                </thead>
                <tbody>
                <template is="dom-repeat" items="{{distributorDetailsList}}">
                  <form
                          is="iron-form"
                          id="form-[[item.id]]"
                          disable-native-validation-ui
                          method="PUT"
                          novalidate>
                  <tr>
                    <td>
                      <ct-editable-switcher class$="[[_computeId(index)]]">
                        <paper-input
                                class="input-element"
                                type="text"
                                required
                                error-message="Please enter distibutor name"
                                no-label
                                value="[[item.name]]"></paper-input>
                      </ct-editable-switcher>
                    </td>
                    <td>
                      <ct-editable-switcher class$="[[_computeId(index)]]">
                        <paper-input
                                class="input-element"
                                type="text"
                                allowed-pattern="[0-9\.]"
                                required
                                error-message="Please enter distibutor contact number"
                                no-label
                                value="[[item.contactNumber]]"></paper-input>
                      </ct-editable-switcher>
                    </td>
                    <td>
                      <ct-editable-switcher class$="[[_computeId(index)]]">
                        <paper-input
                                class="input-element"
                                type="text"
                                required
                                error-message="Please enter distibutor address"
                                no-label
                                value="[[item.address]]"></paper-input>
                      </ct-editable-switcher>
                    </td>
                    <td class="text-center">
                      <paper-icon-button icon="create" class="table-button btn-default btn-sm" on-tap="_editHandler" raised></paper-icon-button>
                      <paper-icon-button icon="delete"  data-item-id$="[[item.id]]" class="table-button btn-danger btn-sm" on-tap="_modalHandler" raised></paper-icon-button>
                    </td>
                  </tr>
                  </form>
                </template>
                </tbody>
              </table>
            </div>
          </div>
        </div>

      </div>

    </paper-material>

    <ct-delete-dialog id='deleteDialog'  subject"Distributor"></ct-delete-dialog>

  </template>

  <script>
      Polymer({

          is: 'ct-view-settings-distributors',

          properties: {
              _isStatusEdit : {
                  type: Boolean,
                  value: function() {
                      return false;
                  }
              },
              distributorDetailsList:Array,
              selected: Number,
          },

          listeners: {
              'iron-form-presubmit':'_formHandler'
          },

          _submitForm : function() {
              this.$.form.submit();
          },

          _formHandler : function(e){

              e.preventDefault();

              var form = this.$.form;

              if(form.validate()) {
                  var formData = form.serialize();
                  data = {};
                  data.name = formData.name;
                  data.contactNumber = formData.contactNumber;
                  data.address = formData.address;

                  console.log('params', formData);

              }
              this.fire('addDistributor', data);
          },

          _computeId : function(idx){
              return 'item-'+idx;
          },

          _computeButtonIcon: function(element){
              if(icon === 'save') {
                  element.setAttribute('icon', 'create');
              } else if(icon === 'create') {
                  element.setAttribute('icon', 'save');
              }
          },

          _computeBtnStyle : function(element){
              if(element.classList.contains('btn-primary')) {
                  element.classList.remove('btn-primary');
                  element.classList.add('btn-default');
              } else if(element.classList.contains('btn-default')){
                  element.classList.remove('btn-default');
                  element.classList.add('btn-primary');
              }
          },

          _toggleStatus : function(element){

              var icon = element.getAttribute('icon');

          },

          _editHandler : function(e){
              var idIdx = '.item-'+e.model.index;
              var inputElems = Polymer.dom(this.root).querySelectorAll(idIdx);
              var isValid = true;

              inputElems.forEach(function(elem){

                  console.log(elem.validate())
                  if(elem.editMode && !elem.validate()){
                      console.log('called');
                      isValid = false;
                  }

                  if(isValid){
                      elem.editMode = !elem.editMode;
                  }


              });

              if(isValid){
                  this._toggleStatus(Polymer.dom(e).localTarget);
              }


          },

          // _editHandler : function(){
          //     var form = this.$$('form-'+e.model.id);
          //     if(this._isStateEdit){
          //         if(form.validate()){
          //             form.submit();
          //         }
          //     } else {
          //         this._toggleStatus();
          //     }
          // },

          _formHandler : function(e){

              var editForm = this.$$('form-'+e.model.id).serialize();
                  data = {},

              e.preventDefault();

              data.name = editForm.name;
              data.contactNumber = editForm.contactNumber;
              data.address = editForm.address;

              this.fire('updateDistributor', params);
              this._toggleStatus();
          },

          _modalHandler : function(e){
            this.$.deleteDialog.key = e.model.item.id;
            this.$.deleteDialog.resource = e.model.item.name
            this.$.deleteDialog.open();
          },

          _deleteDistributor : function(e) {
              this.fire('deleteDistributor', e.detail.id);
          },
      });
  </script>

</dom-module>
