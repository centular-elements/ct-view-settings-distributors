<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../iron-form/iron-form.html">
<link rel="import" href="../ct-core-utils/ct-api-consumer-behaviour.html">
<link rel="import" href="../ct-delete-dialog/ct-delete-dialog.html">
<link rel="import" href="../ct-editable-switcher/ct-editable-switcher.html">
<!--
`ct-view-settings-distributors`
Element to add and view distributor settings
@demo demo/index.html
-->
<dom-module id="ct-view-settings-distributors">
  <template>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <style is="custom-styles">
      :host {
        display: block;
        --paper-input-container:{
          border-top: 1px solid #ccc;
          border-left: 1px solid #ccc;
          border-right: 1px solid #ccc;
          border-bottom: none;
          padding: 0 !important;
        };
        --paper-input-container-input: {
          text-overflow: ellipsis;
          width: calc(100% - 20px);
          margin-left: 10px;
        };
        --paper-input-container-label: {
          margin-left: 10px;
          width: calc(100% - 20px);
        };
      }
      .new-container .row {
        display: flex;
        align-items: center;
      }
      .custom-row {

      }
      .row.dom-repeated-row {
        margin-left: 0;
        margin-right: 0;

        border:1px solid #ccc;
      }
      .dom-repeated-row:nth-of-type(odd) {
          background: #f9f9f9;
      }
      .bordered-content {
        padding: 5px 0;
      }
      .col-input {
        padding-left:10px !important;
        padding-right: 10px !important;
      }
      .margin-10v {
        margin: 10px 0;
      }
      paper-material {
        background: #fff;
        margin-bottom: 15px;
        padding: 10px;
      }
      paper-icon-button + paper-icon-button {
        margin-left: 15px;
      }
      paper-input {
        text-overflow: ellipsis;
        width: calc(~100% - 10px);
      }
    </style>
    <paper-material>
      <div class="fluid-container new-container margin-10v">
        <form
                is="iron-form"
                class="row"
                id="form"
                disable-native-validation-ui
                method="POST"
                novalidate>
          <div class="col-sm-3">
            <paper-input
                    id="newDistName"
                    label="New Distributor Name"
                    type="text"
                    name="name"
                    required
                    error-message="Please provide a name for the new distributor"
                    type="text"></paper-input>
          </div>
          <div class="col-sm-3">
            <paper-input
                    id="newDistNumber"
                    label="New Distributor Number"
                    required
                    name="contactNumber"
                    error-message="Please provide a number for the new distributor"
                    type="text"></paper-input>
          </div>
          <div class="col-sm-4">
            <paper-input
                    id="newDistAddress"
                    label="New Distributor Address"
                    required
                    name="address"
                    error-message="Please provide an address for the new distributor"
                    type="text"></paper-input>
          </div>
          <div class="col-sm-2 bordered">
            <paper-button class="btn btn-primary btn-block" on-tap="_submitForm" raised>Add Distributor</paper-button>
          </div>
        </form>
      </div>
    </paper-material>
    <paper-material>
      <div class="fluid-container">
        <div class="row">
          <div class="col-xs-12">
                <div class="row dom-repeated-row">
                  <div class="col-xs-3 col-input">
                    <div class="bordered-content">
                      Distributor
                    </div>
                  </div>
                  <div class="col-xs-3 col-input">
                    <div class="bordered-content">
                      Contact Number
                    </div>
                  </div>
                  <div class="col-xs-3 col-input">
                    <div class="bordered-content">
                      Address
                    </div>
                  </div>
                  <div class="col-xs-3 text-center col-input">
                    <div class="bordered-content">
                        <span class="text-center">Actions</span>
                    </div>
                  </div>
                </div>
                <template is="dom-repeat" items="{{distributorDetailsList}}">
                  <div class="row dom-repeated-row margin-10v">
                    <form
                            is="iron-form"
                            id="form-[[item.id]]"
                            disable-native-validation-ui
                            method="PUT"
                            novalidate>
                    <div class="col-xs-3 col-input">
                      <div class="bordered-content">
                        <ct-editable-switcher class$="[[_computeId(index)]]"  value-prop="[[item.name]]">
                          <paper-input
                                  class="input-element"
                                  type="text"
                                  name='name'
                                  required
                                  error-message="Please enter distibutor name"
                                  no-label
                                  value="[[item.name]]"></paper-input>
                        </ct-editable-switcher>
                      </div>
                    </div>
                      <div class="col-xs-3 col-input">
                        <div class="bordered-content">
                          <ct-editable-switcher class$="[[_computeId(index)]]"  value-prop="[[item.contactNumber]]">
                            <paper-input
                                    class="input-element"
                                    type="text"
                                    allowed-pattern="[0-9\.]"
                                    name='contactNumber'
                                    required
                                    error-message="Please enter distibutor contact number"
                                    no-label
                                    value="[[item.contactNumber]]"></paper-input>
                          </ct-editable-switcher>
                        </div>
                      </div>
                      <div class="col-xs-3 col-input">
                        <div class="bordered-content">
                          <ct-editable-switcher class$="[[_computeId(index)]]" value-prop="[[item.address]]">
                          <paper-input
                                  class="input-element"
                                  type="text"
                                  name='address'
                                  required
                                  error-message="Please enter distibutor address"
                                  no-label
                                  value="[[item.address]]"></paper-input>
                        </ct-editable-switcher>
                      </div>
                      </div>
                      <div class="col-xs-3 col-input text-center">
                        <div class="bordered-content">
                          <paper-icon-button icon="create" class="table-button btn-default btn-sm" on-tap="_editHandler" raised></paper-icon-button>
                          <paper-icon-button icon="delete"  data-item-id$="[[item.id]]" class="table-button btn-danger btn-sm" on-tap="_modalHandler" raised></paper-icon-button>
                        </div>
                      </div>

                    </form>
                    </div>

                </template>

            </div>
          </div>
        </div>

    </paper-material>
    <ct-delete-dialog id='deleteDialog'  subject"Distributor"></ct-delete-dialog>
  </template>
  <script>
  Polymer({
          is: 'ct-view-settings-distributors',
          properties: {
              _isStatusEdit : {
                  type: Boolean,
                  value: function() {
                      return false;
                  }
              },
              distributorDetailsList:Array,
              selected: Number,
          },
          listeners: {
              'iron-form-presubmit':'_formHandler',
              'delete' : '_deleteDistributor',
              '_fomrHandler': '_editFormHandler'
          },
          _submitForm : function() {
              this.$.form.submit();
          },
          _formHandler : function(e){
              e.preventDefault();
              var form = this.$.form;
              if(form.validate()) {
                  var formData = form.serialize();
                  data = {};
                  data.name = formData.name;
                  data.contactNumber = formData.contactNumber;
                  data.address = formData.address;
              }
              this.fire('addDistributor', data);
          },
          _computeId : function(idx){
              return 'item-'+idx;
          },
          _computeButtonIcon: function(element){
              if(icon === 'save') {
                  element.setAttribute('icon', 'create');
              } else if(icon === 'create') {
                  element.setAttribute('icon', 'save');
              }
          },
          _computeBtnStyle : function(element){
              if(element.classList.contains('btn-primary')) {
                  element.classList.remove('btn-primary');
                  element.classList.add('btn-default');
              } else if(element.classList.contains('btn-default')){
                  element.classList.remove('btn-default');
                  element.classList.add('btn-primary');
              }
          },
          _toggleStatus : function(element){
              //toggles between editable and non editable
              this._isStateEdit = !this._isStateEdit;
          },
          _editHandler : function(e){
              var idIdx = '.item-'+e.model.index;
              var inputElems = Polymer.dom(this.root).querySelectorAll(idIdx);
              var isValid = true;
              //if in editing state
              if(this._isStateEdit){
                inputElems.forEach(function(elem){
                    if(elem.editMode && !elem.validate()){
                        isValid = false;
                    }
                    if(isValid){
                        elem.editMode = !elem.editMode;
                    }
                });
                //submit the form
                if(isValid){
                  this._editFormHandler(e);
                }
              //make editable
              } else {
                 this._toggleStatus();
               }
          },
           _editFormHandler: function(e){
             var idIdx = '#form-'+e.model.item.id;
             var formElems = this.$$(idIdx);
             if(!formElems.validate()){
                return;
              }
              var editForm = formElems.serialize()
                  data = {};
              e.preventDefault();
              data.id = e.model.item.id;
              data.name = editForm.name;
              data.contactNumber = editForm.contactNumber;
              data.address = editForm.address;
              this.fire('updateDistributor', data);
              this._toggleStatus();
          },
          _modalHandler : function(e){
            this.$.deleteDialog.key = e.model.item.id;
            this.$.deleteDialog.resource = e.model.item.name
            this.$.deleteDialog.subject = "Distrubutor"
            this.$.deleteDialog.open();
          },
          _deleteDistributor : function(e) {
              this.fire('deleteDistributor', e.detail);
          },
      });
  </script>

</dom-module>
